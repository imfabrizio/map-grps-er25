<!DOCTYPE html>
<html>
<head>
    <title>Percorso Gara di Primo Soccorso</title>
    <meta charset="utf-8">
    <meta name="viewport" content="initial-scale=1, width=device-width">
    <link rel="stylesheet" href="https://atlas.microsoft.com/sdk/javascript/mapcontrol/2/atlas.min.css">
    <script src="https://atlas.microsoft.com/sdk/javascript/mapcontrol/2/atlas.min.js"></script>
    <script src="https://atlas.microsoft.com/sdk/javascript/service/2/atlas-service.min.js"></script>
    <style>
        html, body, #map { height: 100%; margin: 0; padding: 0; font-family: sans-serif; }
        #centerBtn, #exportBtn {
            position: absolute;
            top: 10px;
            z-index: 1000;
            padding: 8px 12px;
            background-color: white;
            border: 1px solid #ccc;
            border-radius: 5px;
            cursor: pointer;
        }
        #centerBtn { left: 10px; }
        #exportBtn { left: 130px; }
        #styleSelect {
            position: absolute;
            top: 10px;
            right: 130px;
            z-index: 1000;
            padding: 8px 12px;
        }
        #legend, #timer {
            position: absolute;
            z-index: 1000;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 14px;
        }
        #legend {
            bottom: 10px;
            right: 10px;
            background: white;
            box-shadow: 0 0 5px rgba(0,0,0,0.3);
        }
        #timer {
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div id="map"></div>

    <button id="centerBtn" onclick="map.setCamera({ center: [10.52188556692596, 44.4603971115963], zoom: 16 })">Centra Mappa</button>
    <button id="exportBtn" onclick="exportGPX()">Esporta GPX</button>
    <select id="styleSelect" onchange="map.setStyle(this.value)">
        <option value="road">Mappa Diurna</option>
        <option value="grayscale_dark">Mappa Notturna</option>
        <option value="night">Modalit√† Notte</option>
    </select>

    <div id="timer">00:00</div>

    <div id="legend">
        <strong>Legenda:</strong><br>
        <span style="color:green;">üü© Partenza</span><br>
        <span style="color:red;">üü• Tappa</span><br>
        <span style="color:blue;">üü¶ Arrivo</span>
    </div>

    <script>
        const subscriptionKey = 'BAqgYkgcYKIiyJfr7BOGSIFySA2Yw14pckF6xDum7uUvMptUSF19JQQJ99BFAC5RqLJioKNfAAAgAZMP45SF';

        const stazioni = [
            { pos: [10.52188556692596, 44.4603971115963], titolo: "Sede Croce Rossa" },
            { pos: [10.520888, 44.463778], titolo: "Scenza CHARLIE" },
            { pos: [10.5172802, 44.4521687], titolo: "Scena DELTA" },
            { pos: [10.5186218, 44.4534773], titolo: "Scena ECHO" },
            { pos: [10.5189889, 44.4542510], titolo: "Scena ALFA" },
            { pos: [10.5177559, 44.4555097], titolo: "Scena BRAVO" }
        ];

        const map = new atlas.Map('map', {
            center: stazioni[0].pos,
            zoom: 16,
            style: 'road',
            authOptions: {
                authType: 'subscriptionKey',
                subscriptionKey: subscriptionKey
            }
        });

        map.events.add('ready', function () {
            let currentPopup = null;
            const datasource = new atlas.source.DataSource();
            map.sources.add(datasource);

            stazioni.forEach((s, index) => {
                let color = 'red';
                if (index === 0) color = 'green';
                else if (index === stazioni.length - 1) color = 'blue';

                const marker = new atlas.HtmlMarker({
                    position: s.pos,
                    htmlContent: `
                        <div style="
                            display:flex;
                            align-items:center;
                            background:white;
                            border: 2px solid ${color};
                            border-radius:6px;
                            padding:4px 8px;
                            box-shadow:0 0 6px rgba(0,0,0,0.5);
                            font-size:14px;
                        ">
                            <span style="font-size:20px; margin-right:6px;">‚õëÔ∏è</span>
                            <span><strong>${index + 1}</strong>. ${s.titolo}</span>
                        </div>`
                });

                map.markers.add(marker);

                const popup = new atlas.Popup({
                    content: `<div style="padding:5px;"><strong>${index + 1}. ${s.titolo}</strong></div>`,
                    position: s.pos
                });

                map.events.add('click', marker, () => {
                    if (currentPopup) currentPopup.close();
                    popup.open(map);
                    currentPopup = popup;
                });
            });

            // ROUTE SU STRADA
            const coords = stazioni.map(s => `${s.pos[1]},${s.pos[0]}`).join(':');
            const routeUrl = `https://atlas.microsoft.com/route/directions/json?api-version=1.0&query=${coords}&subscription-key=${subscriptionKey}`;

            fetch(routeUrl)
                .then(res => res.json())
                .then(data => {
                    const routeCoords = data.routes[0].legs.flatMap(leg => leg.points.map(p => [p.longitude, p.latitude]));
                    const routeLine = new atlas.data.Feature(new atlas.data.LineString(routeCoords));
                    datasource.add(routeLine);

                    const routeLayer = new atlas.layer.LineLayer(datasource, null, {
                        strokeColor: 'deepskyblue',
                        strokeWidth: 4
                    });
                    map.layers.add(routeLayer);
                });
        });

        // TIMER GARA
        let seconds = 0;
        setInterval(() => {
            seconds++;
            const m = String(Math.floor(seconds / 60)).padStart(2, '0');
            const s = String(seconds % 60).padStart(2, '0');
            document.getElementById('timer').innerText = `${m}:${s}`;
        }, 1000);

        // ESPORTAZIONE GPX
        function exportGPX() {
            let gpx = `<?xml version="1.0" encoding="UTF-8"?>
<gpx version="1.1" creator="Azure Maps" xmlns="http://www.topografix.com/GPX/1/1">
<trk><name>Percorso Gara di Primo Soccorso</name><trkseg>\n`;

            stazioni.forEach(s => {
                gpx += `<trkpt lat="${s.pos[1]}" lon="${s.pos[0]}"></trkpt>\n`;
            });

            gpx += `</trkseg></trk></gpx>`;

            const blob = new Blob([gpx], { type: 'application/gpx+xml' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'percorso.gpx';
            a.click();
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>
